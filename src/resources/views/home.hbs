<div class="page-container">
    <!-- Content Wrapper START -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- Breadcrumb Start -->
            <div class="row">
                <!-- POST -->

                <!--  Post -->
                <div class="col-md-8 ">
                    <!-- Create Post -->
                    <div class="card luan-mb-0">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <div class="d-flex flex-row">
                                    <img class="avatar" src="/{{user.avatar}}" alt="">
                                    <input readonly data-toggle="modal" data-target="#modal-post"
                                        class="ml-2 form-control mt-1 post-box text-left"
                                        placeholder="Bạn đang nghĩ gì ?">
                                </div>
                                <hr class="mt-2 mb-2" style=" border-top: 1px solid rgb(214, 212, 212);">
                                <div class="d-flex flex-row  justify-content-center ">

                                    <label class="mb-0 btn btn-light col-md-5 custom-input mr-1" for="upload-photo"><i
                                            class="far fa-images"></i> Ảnh </label>
                            
                                    <label class="mb-0 btn btn-light col-md-5 custom-input ml-1" for="upload-video"><i
                                            class="fab fa-youtube"></i> Video</label>
                                   
                                </div>


                            </li>
                        </ul>
                    </div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12" id="new-feed">

                        </div>
                    </div>
                </div>
                    <!-- Card test -->

                    
                <!-- End Post -->
                <!-- Announce -->
                <div class="col-md-4">

                </div>
                <!--End  Announce -->
            </div>
            <!-- Breadcrumb End -->
        </div>


    </div>
    <!-- Content Wrapper END -->

    <!-- Footer START -->
    

</div>


<!-- Modal  Post-->
<div class="modal fade" id="modal-post" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content ">
            <div class="modal-header">
                <h3 class="modal-title" id="exampleModalLongTitle">Tạo bài viết</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <img class="avatar" src="/{{user.avatar}}" alt="">
                <div class="pl-2 d-flex flex-column">
                    <p class="avatar-name">{{user.fullname}}</p>
                    <div class="badge badge-light col-md-2 col-2"><i class="fas fa-globe-asia"></i> Công khai <i
                            class="fas fa-caret-down"></i></div>
                </div>
                <form method="POST" id="form-add-post" >
                    <textarea name="caption" id="post-caption" placeholder="Bạn đang nghĩ gì thế ? " type="text"
                        style="border: none; border-width: 0; box-shadow: none;font-size:17px" class="mt-1 form-control"></textarea>
                    <div class="img-post-field">
                        <div class="edit-post-field">
                            <div class=" d-flex flex-row">
                                <button class="btn btn-light edit-img-post mt-4 ml-4 "> <i class="fas fa-folder-plus"></i>
                                    Thêm ảnh</button>
                                <i class="far fa-times-circle float-right remove-img-post mr-3 mt-4"></i>
                            </div>

                        </div>


                        {{!-- <img src="img/dark-souls.jpg" class=" float-right form-control " style="height: auto;"> --}}

                    </div>
                    <input type="text" name="video" id="upload-video">
                    <input type="file" name="image"  accept="image/*" multiple id="upload-photo">
                    <div class="add-to-post mt-3">
                        <button type="button" class="btn btn-light btn-circle float-right" data-toggle="tooltip"
                            data-placement="top" title="Nhiều hơn"> <i class="fas fa-ellipsis-h"></i> </button>
                        <button type="button" class="btn btn-light btn-circle float-right" data-toggle="tooltip"
                            data-placement="top" title="Thêm video"> <i class="fab fa-youtube text-danger"></i> </button>
                        <button type="button" class="btn btn-light btn-circle float-right edit-img-post" data-toggle="tooltip"
                            data-placement="top" title="Thêm ảnh"> <i class="fas fa-image text-success"></i> </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" data-id="{{user._id}}" id="luan-btn" form="form-add-post" class="btn btn-primary">Đăng</button>
            </div>
        </div>
    </div>
</div>
<!-- End Modal  Post-->

<script>
    var postPage = 1;
    var disabledLoadMore = false;
    $(document).ready(function() {
        
        getPosts(1);
    });

    $(window).scroll(function() {
        var scrollTop = $(this).scrollTop();
        var heightWindow = $(this).height();
        var documentHeight = $(document).height();
        if (Math.round(heightWindow + scrollTop) >= documentHeight -100 ){
            console.log(disabledLoadMore)
            if (!disabledLoadMore ) {
                console.log(disabledLoadMore);
                loadMore();
            }
            
        }
    })

    document.addEventListener('DOMContentLoaded', () => {
        let button = document.getElementById('luan-btn');
        let id = button.getAttribute('data-id');
        const URL = `/post/${id}`;
        button.onclick = (event) => {
            var caption = document.getElementById('post-caption').value;
            var imageFile = document.getElementById('upload-photo').files;
            var video = document.getElementById('upload-video').value;

            var formData = new FormData();
            formData.append('caption', caption);
            formData.append('image', imageFile[0]);
            formData.append('video', video);
            formData.append('thematic', '');
            formData.append('userID', id);

            $.ajax({
                url: URL,
                method: "POST",
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    alert(data.message);
                    $('#new-feed').empty();
                    getPosts();
                }
            });
        }
    
    });

    function getPosts(page) {
        const URL = `/post/api?page=${page}`;
        $.ajax({
            url: URL,
            method: "GET",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data.length === 0) {
                    disabledLoadMore = true;
                }
                renderPost(data);
            }, error: function (data) {
                console.log(typeof data);
            }
        })
    }
    
    function renderPost(posts) {
        let html = '';

        $.each(posts, function(index, post) {
            html += `<div class="card mt-1 luan-card">`
                html +=`<div class="card-header pb-0">`
                    html +=`<img class="avatar" src="/${post.userAvatar}" alt="">`
                    html +=`<div class="pl-2 d-flex flex-column">`
                        html +=`<p class="avatar-name"> ${post.userName}</h5>`
                        html +=`<p class="p-0 post-date">${moment(post.createAt).fromNow()}</p>`
                    html += `</div>`
                html +=`</div>`
                html +=`<div class="card-body pt-0 pb-0">`
                    html +=`<blockquote class="blockquote mb-0 ">`
                        html +=`<p>${post.caption}</p>`
                        html +=`<div class="row">`
                            if (post.image !== '') {
                                html +=`<div class="col-sm-2 col-xs-2"></div>`
                                html +=`<div class="col-sm-8 col-xs-8 p-0"> `
                                    html +=`<div class="card-body p-1"> `
                                        html +=`<img class="luan-post-img" height="400px" src="/${post.image}"`
                                    html +=`</div>`
                                html +=`</div>`
                            }
                        html +=`</div>`
                        html +=`<div class="row">`
                            if (post.video !== ''){
                                html +=`<div class="col-sm-2 col-xs-2"></div>`
                                html +=`<div class="col-sm-8 col-xs-8 p-0"> `
                                    html +=`<div class="card-body p-1"> `
                                        html +=`<iframe width="100%"  src="${post.video}"></iframe>`
                                    html +=`</div>`
                                html +=`</div>`
                            }
                        html +=`</div>`
                        html += `<footer class="blockquote-footer">`
                            html +=`<cite title="Source Title"></cite>`
                        html +=`</footer>`
                    html +=`</blockquote>`
                html +=`</div>`
                html +=`<div class="card-body pt-2 text-muted">`
                    html +=`<div class="d-flex ">`
                        html +=`<div class="like-count"><i class="far fa-thumbs-up"></i> 890 </div>`
                        html +=`<div class="ml-auto text-right"> 20 Comments </div>`
                    html +=`</div>`
                html +=`</div>`
                html +=`<hr class="mt-0 mb-1 ">`
                html +=`<div class="d-flex post-react justify-content-around ">`
                    html +=`<button class="btn btn-light col-md-4"> <i class="far fa-thumbs-up"></i> Like </button>`
                    html +=`<button  data-toggle="collapse" data-target="#luan${post._id}"  class="btn btn-light col-md-4"><i class="far fa-comment-alt"></i> Comment </button>`
                    html +=`<button class="btn btn-light col-md-4"><i class="far fa-share-square"></i> Share </button>`
                html +=`</div>`
            html +=`</div>`

           
            html +=`<div class="collapse" id="luan${post._id}">`
                html +=`<div class="card card-body mb-0" >`
                    html +=`<div class="pl-2 d-flex luan-comment">`
                        html +=`<img class="avatar-comment mt-1 mr-2" src="${post.userAvatar}" alt="">`
                        html +=`<input type="text" name="comment" id="cmt${post._id}"  class="form-control rounded  col-lg-11 col-md-10 col-sm-8 mt-1" placeholder="Viết bình luận ...">`
                        html += `<button type="button" data-user="{{user._id}}" data-id="${post._id}" onclick="sendComment(this)" class="btn btn-light"><i class="far fa-paper-plane"></i></button>`
                    html +=`</div>`
                    html +=`<div class="" id="luannt${post._id}">`
                    html +=`</div>`
                html +=`</div>`
                
            html +=`</div>`

            getComment(post._id);
        })

        $('#new-feed').append(html);
    }

    function sendComment(btn) {
        let id = btn.getAttribute('data-id');
        let content = document.getElementById('cmt'+id);
        let idUser = btn.getAttribute('data-user');
        console.log(id);

        if (content.value === '') {
            alert('Bạn chưa bình luận điều gì!');
        }
        else  {
            const URL = `/comment/api`;

            let data = {
                content: content.value,
                postID: id,
                userID: idUser
            };

            $.ajax({
                url: URL,
                method: "POST",
                data: data,
                contentType: "application/x-www-form-urlencoded",
                dataType: 'json',
                success: function (cmt) {
                    alert('đã cmt');
                    content.value = '';
                    $("#luannt"+id).empty();
                    getComment(id);
                }
                , error: function (err) {
                    console.log(err);
                }
            });
        }
    }
    function getComment(postID) {
        const URL = `/comment/api/${postID}`;
        $.ajax({
            url: URL,
            method: "GET",
            dataType: "json",
            success: function (data) {
                renderComment(data, postID);
            }
        })
    }
    function renderComment(comments, id) {
        let html ='';
         $.each(comments, function(index, comment) {
            html +=`<div class="pl-2 d-flex flex-row  align-items-start mt-2">`
                html +=`<img class="avatar-comment mt-2 " src="/${comment.userAvatar}" >`
                html +=`<div style=" display: inline-block; background-color : #e6e7eb" class="rounded p-2 pr-3 ml-2  mt-2"  > `
                    html +=`<span class="font-weight-bold" >${comment.userName}</span> <span class="float-right post-date">${moment(comment.createAt).fromNow()}</span>`
                    html +=`<div >`
                        html+= `${comment.content}`
                    html+= `</div>`
                html +=`</div>`
            html +=`</div>`
         });
        $("#luannt"+id).append(html);
    }
    function loadMore() {
        postPage++;
        getPosts(postPage);
    }
</script>
